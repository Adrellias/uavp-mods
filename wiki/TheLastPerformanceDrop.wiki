#summary The 40MHz version of UAVX on the 18F2620 is almost as far is it goes. There are a few more steps you take to push the envelope on our Legacy UAVP Board.

=== Introduction ====

The 40MHz version of UAVX on the 18F2620 is almost as far is it goes for our "Legacy" UAVP board. 

Going from 16MHz to 40MHz using a simple 10MHz crystal upgrade at the cost of a dollar or so is the cheapest performance upgrade in town. It allowed us to go from reading the sensors and updating the motor commands 125 times a second or 125Hz up to 250Hz. That with a workover of the control code gave much crisper control response.

If you fly UAVX with a span of around 600mm or greater as most of us do then 250Hz should be satisfactory for most FPV work.

=== Fast PWM ESCs ===

The PIC processor spends half its time every control update to generate the 1 to 2 millisecond wide pulses for our PWM ESCs.

As was stated here way way back off the shelf PWM ESCs were geared to how throttles are used on conventional aircraft which means relatively slow changes. This meant that many of them had and still have filters to slow down the rate at which the throttle can be opened or closed regardless of how fast you move the stick.  This is EXACTLY what we do not want for multicopters. 

So most of the research now a few years later out there goes into so called Fast PWM ESCs which run at a fraction of a Hz below 500Hz. Just increasing the update rate tricked the ESC filters allowing more rapid changes. So today we are up at a fraction under 500Hz update rate on really cheap ESCs $10-20 for 30A ESCs is normal.

We are at 250Hz so what can we do?

=== I2C ESCs ===  

I2C ESCs can be updated in a fraction of a millisecond and so run immediately at 500Hz this being automatic with the current UAVX when I2C ESCs are selected.  The PID parameters need to have the I parameter halved as an initial starting point.

=== I Don't Have I2C ESCs ===

The simple trick is to have a translator that takes the I2C signals generated by UAVX and convert them to Fast PWM. Look up I2C to PWM converters. There is at least one out there that has 8 PWM outputs ;).

=== Other Limits - the venerable HMC6352 ===

Most of the I2C sensors we currently use 400KHz communication rates. Note the "K" in front of the Hz so this is 400000Hz and is not to be confused with the control update rate. 

One device we use however is the HMC6352 Compass and it can only communicate at 100KHz. Having code in UAVX which has to switch between these two rates is a little complicated and in practice means that the 400KHz devices are being run at under 300KHz chewing up time.

The HMC6882L magnetometer communicates at 400KHz and if used allows us to run close to 400KHz with simpler code.  The magnetometer also, in theory, allows us to compensate for the aircraft not being level.

Bottom line consider buying one and select the 40MHz hexfiles without I2C100KHz in their name.

  